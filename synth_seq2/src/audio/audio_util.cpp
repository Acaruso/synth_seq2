#include "audio_util.hpp"

#include <stdlib.h>

const unsigned scale = (1 << 23) - 1;

unsigned scaleSignal(double sig)
{
    double f = sig * scale;
    unsigned u = (unsigned)f << 8;
    return u;
}

unsigned mstosamps(double ms)
{
    return (unsigned)(ms * 44.1);
}

// see: https://musicinformationretrieval.com/midi_conversion_table.html
const std::unordered_map<int, double> mtofMap({
    // octave 0
    { 12, 16.352 },
    { 13, 17.324 },
    { 14, 18.354 },
    { 15, 19.445 },
    { 16, 20.602 },
    { 17, 21.827 },
    { 18, 23.125 },
    { 19, 24.5 },
    { 20, 25.957 },
    { 21, 27.5 },
    { 22, 29.135 },
    { 23, 30.868 },

    // octave 1
    { 24, 32.703 },
    { 25, 34.648 },
    { 26, 36.708 },
    { 27, 38.891 },
    { 28, 41.203 },
    { 29, 43.654 },
    { 30, 46.249 },
    { 31, 48.999 },
    { 32, 51.913 },
    { 33, 55 },
    { 34, 58.27 },
    { 35, 61.735 },

    // octave 2
    { 36, 65.406 },
    { 37, 69.296 },
    { 38, 73.416 },
    { 39, 77.782 },
    { 40, 82.407 },
    { 41, 87.307 },
    { 42, 92.499 },
    { 43, 97.999 },
    { 44, 103.83 },
    { 45, 110 },
    { 46, 116.54 },
    { 47, 123.47 },

    // octave 3
    { 48, 130.81 },
    { 49, 138.59 },
    { 50, 146.83 },
    { 51, 155.56 },
    { 52, 164.81 },
    { 53, 174.61 },
    { 54, 185 },
    { 55, 196 },
    { 56, 207.65 },
    { 57, 220 },
    { 58, 233.08 },
    { 59, 246.94 },

    // ocatave 4
    { 60, 261.63 },
    { 61, 277.18 },
    { 62, 293.66 },
    { 63, 311.13 },
    { 64, 329.63 },
    { 65, 349.23 },
    { 66, 369.99 },
    { 67, 392 },
    { 68, 415.3 },
    { 69, 440 },
    { 70, 466.16 },
    { 71, 493.88 },

    // octave 5
    { 72, 523.25 },
    { 73, 554.37 },
    { 74, 587.33 },
    { 75, 622.25 },
    { 76, 659.26 },
    { 77, 698.46 },
    { 78, 739.99 },
    { 79, 783.99 },
    { 80, 830.61 },
    { 81, 880 },
    { 82, 932.33 },
    { 83, 987.77 },

    // octave 6
    { 84, 1046.5 },
    { 85, 1108.7 },
    { 86, 1174.7 },
    { 87, 1244.5 },
    { 88, 1318.5 },
    { 89, 1396.9 },
    { 90, 1480 },
    { 91, 1568 },
    { 92, 1661.2 },
    { 93, 1760 },
    { 94, 1864.7 },
    { 95, 1975.5 },

    // octave 7
    { 96, 2093 },
    { 97, 2217.5 },
    { 98, 2349.3 },
    { 99, 2489 },
    { 100, 2637 },
    { 101, 2793.8 },
    { 102, 2960 },
    { 103, 3136 },
    { 104, 3322.4 },
    { 105, 3520 },
    { 106, 3729.3 },
    { 107, 3951.1 }
});

double mtof(int m)
{
    return mtofMap.at(m);
}

double getRand()
{
    return rand() / (RAND_MAX + 1.);
}
